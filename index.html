<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2026 Drink Tracker</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Supabase configuration
    const SUPABASE_URL = 'https://jftfalkxfsasptpoqztd.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmdGZhbGt4ZnNhc3B0cG9xenRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUyNjA5MjgsImV4cCI6MjA1MDgzNjkyOH0.sb_publishable_eJ_ockA-t5c8P6KWuZGrvg_F6720s6_';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function DrinkTracker() {
      const [drinks, setDrinks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showOtherForm, setShowOtherForm] = useState(false);
      const [customDrink, setCustomDrink] = useState('');
      const [quickLogDrinks, setQuickLogDrinks] = useState([
        { name: 'Martini', category: 'Cocktail' },
        { name: 'Gin & Tonic', category: 'Cocktail' },
        { name: 'Guinness', category: 'Beer' },
        { name: 'Narragansett', category: 'Beer' },
        { name: 'White Wine', category: 'Wine' },
        { name: 'Red Wine', category: 'Wine' }
      ]);
      const [dismissedSuggestions, setDismissedSuggestions] = useState([]);
      const [editMode, setEditMode] = useState(false);
      const [editingDrink, setEditingDrink] = useState(null);
      const [editName, setEditName] = useState('');
      const [editCategory, setEditCategory] = useState('');

      // Load data from Supabase and localStorage
      useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          // Load drinks from Supabase
          const { data: drinksData, error } = await supabase
            .from('drinks')
            .select('*')
            .order('timestamp', { ascending: false });

          if (error) throw error;
          
          if (drinksData) {
            setDrinks(drinksData);
          }

          // Load quick log and dismissed from localStorage
          const storedQuickLog = localStorage.getItem('quicklog-2026');
          if (storedQuickLog) {
            setQuickLogDrinks(JSON.parse(storedQuickLog));
          }

          const storedDismissed = localStorage.getItem('dismissed-suggestions-2026');
          if (storedDismissed) {
            setDismissedSuggestions(JSON.parse(storedDismissed));
          }
        } catch (error) {
          console.error('Error loading data:', error);
        } finally {
          setLoading(false);
        }
      };

      const saveQuickLog = (newQuickLog) => {
        localStorage.setItem('quicklog-2026', JSON.stringify(newQuickLog));
      };

      const saveDismissed = (newDismissed) => {
        localStorage.setItem('dismissed-suggestions-2026', JSON.stringify(newDismissed));
      };

      const normalizeDrinkName = (name) => {
        return name.toLowerCase().trim();
      };

      const quickAddDrink = async (name, category) => {
        try {
          const newDrink = {
            name: name,
            category: category,
            timestamp: new Date().toISOString()
          };

          const { data, error } = await supabase
            .from('drinks')
            .insert([newDrink])
            .select();

          if (error) throw error;

          if (data) {
            setDrinks([data[0], ...drinks]);
          }
        } catch (error) {
          console.error('Error adding drink:', error);
          alert('Failed to add drink. Please try again.');
        }
      };

      const addCustomDrink = async (category) => {
        if (!customDrink.trim()) return;
        
        try {
          const newDrink = {
            name: customDrink.trim(),
            category: category,
            timestamp: new Date().toISOString()
          };

          const { data, error } = await supabase
            .from('drinks')
            .insert([newDrink])
            .select();

          if (error) throw error;

          if (data) {
            setDrinks([data[0], ...drinks]);
          }
          
          setCustomDrink('');
          setShowOtherForm(false);
        } catch (error) {
          console.error('Error adding drink:', error);
          alert('Failed to add drink. Please try again.');
        }
      };

      const deleteDrink = async (id) => {
        try {
          const { error } = await supabase
            .from('drinks')
            .delete()
            .eq('id', id);

          if (error) throw error;

          setDrinks(drinks.filter(d => d.id !== id));
        } catch (error) {
          console.error('Error deleting drink:', error);
          alert('Failed to delete drink. Please try again.');
        }
      };

      const removeFromQuickLog = (drinkName) => {
        const updated = quickLogDrinks.filter(d => d.name !== drinkName);
        setQuickLogDrinks(updated);
        saveQuickLog(updated);
      };

      const updateQuickLogDrink = (oldName, newName, newCategory) => {
        const updated = quickLogDrinks.map(d => 
          d.name === oldName ? { name: newName.trim(), category: newCategory } : d
        );
        setQuickLogDrinks(updated);
        saveQuickLog(updated);
        setEditingDrink(null);
        setEditName('');
        setEditCategory('');
      };

      const startEditingDrink = (drink) => {
        setEditingDrink(drink.name);
        setEditName(drink.name);
        setEditCategory(drink.category);
      };

      const addToQuickLog = (drinkName, category) => {
        const updated = [...quickLogDrinks, { name: drinkName, category: category }];
        setQuickLogDrinks(updated);
        saveQuickLog(updated);
      };

      const dismissSuggestion = (drinkName) => {
        const updated = [...dismissedSuggestions, normalizeDrinkName(drinkName)];
        setDismissedSuggestions(updated);
        saveDismissed(updated);
      };

      const getSuggestion = () => {
        const drinkCounts = {};
        
        drinks.forEach(drink => {
          const normalized = normalizeDrinkName(drink.name);
          const isInQuickLog = quickLogDrinks.some(qd => normalizeDrinkName(qd.name) === normalized);
          const isDismissed = dismissedSuggestions.includes(normalized);
          
          if (!isInQuickLog && !isDismissed) {
            if (!drinkCounts[normalized]) {
              drinkCounts[normalized] = { count: 0, originalName: drink.name, category: drink.category };
            }
            drinkCounts[normalized].count++;
          }
        });

        for (const [normalized, data] of Object.entries(drinkCounts)) {
          if (data.count >= 3) {
            return { name: data.originalName, category: data.category, count: data.count };
          }
        }
        return null;
      };

      const suggestion = getSuggestion();

      const exportToCSV = () => {
        if (drinks.length === 0) {
          alert('No drinks to export yet!');
          return;
        }

        const headers = ['Name', 'Category', 'Date', 'Time', 'Timestamp'];
        const rows = drinks.map(drink => {
          const date = new Date(drink.timestamp);
          const dateStr = date.toLocaleDateString('en-US');
          const timeStr = date.toLocaleTimeString('en-US');
          return [
            drink.name,
            drink.category,
            dateStr,
            timeStr,
            drink.timestamp
          ];
        });

        const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `drink-tracker-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const formatDate = (timestamp) => {
        const date = new Date(timestamp);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
          return 'Today';
        } else if (date.toDateString() === yesterday.toDateString()) {
          return 'Yesterday';
        } else {
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
      };

      const formatTime = (timestamp) => {
        return new Date(timestamp).toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
      };

      const getStats = () => {
        const total = drinks.length;
        const beer = drinks.filter(d => d.category === 'Beer').length;
        const wine = drinks.filter(d => d.category === 'Wine').length;
        const cocktail = drinks.filter(d => d.category === 'Cocktail').length;
        return { total, beer, wine, cocktail };
      };

      const stats = getStats();

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white flex items-center justify-center">
            <div className="text-2xl">Loading...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
          <div className="max-w-2xl mx-auto p-6 pb-24">
            <div className="text-center mb-8 pt-8">
              <h1 className="text-4xl font-bold mb-2">2026 Drink Tracker</h1>
              <p className="text-slate-300">Track every drink, understand your habits</p>
            </div>

            {suggestion && !editMode && (
              <div className="bg-green-500/20 border border-green-500/50 backdrop-blur rounded-xl p-4 mb-6 flex items-center justify-between">
                <div className="flex-1">
                  <div className="font-semibold">Add to Quick Log?</div>
                  <div className="text-sm text-slate-300">
                    You've logged "{suggestion.name}" {suggestion.count} times
                  </div>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => addToQuickLog(suggestion.name, suggestion.category)}
                    className="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-semibold transition-colors"
                  >
                    Add
                  </button>
                  <button
                    onClick={() => dismissSuggestion(suggestion.name)}
                    className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors"
                  >
                    Dismiss
                  </button>
                </div>
              </div>
            )}

            <div className="bg-white/10 backdrop-blur rounded-2xl p-6 mb-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <div className="text-slate-300 text-sm mb-1">Total in 2026</div>
                  <div className="text-5xl font-bold">{stats.total}</div>
                </div>
                <svg className="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
              </div>
              <div className="grid grid-cols-3 gap-4 pt-4 border-t border-white/20">
                <div className="text-center">
                  <div className="text-2xl font-bold text-amber-400">{stats.beer}</div>
                  <div className="text-xs text-slate-300 mt-1">Beer</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-pink-400">{stats.cocktail}</div>
                  <div className="text-xs text-slate-300 mt-1">Cocktail</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-red-400">{stats.wine}</div>
                  <div className="text-xs text-slate-300 mt-1">Wine</div>
                </div>
              </div>
            </div>

            <div className="mb-6">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-slate-300">Quick Log</h2>
                <button
                  onClick={() => {
                    setEditMode(!editMode);
                    setEditingDrink(null);
                  }}
                  className="text-sm text-purple-400 hover:text-purple-300 flex items-center gap-1"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  {editMode ? 'Done' : 'Edit'}
                </button>
              </div>

              {editingDrink && (
                <div className="bg-white/10 backdrop-blur rounded-xl p-4 mb-3">
                  <div className="text-sm font-semibold mb-3">Edit Drink</div>
                  <input
                    type="text"
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    className="w-full bg-white/20 rounded-lg px-4 py-3 mb-3 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-purple-400"
                    placeholder="Drink name"
                  />
                  <div className="text-sm text-slate-300 mb-2">Category:</div>
                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={() => setEditCategory('Beer')}
                      className={`flex-1 border rounded-lg py-2 font-semibold transition-colors ${
                        editCategory === 'Beer' 
                          ? 'bg-amber-500 border-amber-500' 
                          : 'bg-amber-500/20 border-amber-500/50 hover:bg-amber-500/40'
                      }`}
                    >
                      Beer
                    </button>
                    <button
                      onClick={() => setEditCategory('Cocktail')}
                      className={`flex-1 border rounded-lg py-2 font-semibold transition-colors ${
                        editCategory === 'Cocktail' 
                          ? 'bg-pink-500 border-pink-500' 
                          : 'bg-pink-500/20 border-pink-500/50 hover:bg-pink-500/40'
                      }`}
                    >
                      Cocktail
                    </button>
                    <button
                      onClick={() => setEditCategory('Wine')}
                      className={`flex-1 border rounded-lg py-2 font-semibold transition-colors ${
                        editCategory === 'Wine' 
                          ? 'bg-red-500 border-red-500' 
                          : 'bg-red-500/20 border-red-500/50 hover:bg-red-500/40'
                      }`}
                    >
                      Wine
                    </button>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => updateQuickLogDrink(editingDrink, editName, editCategory)}
                      className="flex-1 bg-purple-500 hover:bg-purple-600 rounded-lg py-2 font-semibold transition-colors"
                    >
                      Save
                    </button>
                    <button
                      onClick={() => {
                        setEditingDrink(null);
                        setEditName('');
                        setEditCategory('');
                      }}
                      className="px-6 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}

              <div className="grid grid-cols-2 gap-3 mb-3">
                {quickLogDrinks.map((drink) => (
                  <div key={drink.name} className="relative">
                    <button
                      onClick={() => {
                        if (editMode) {
                          startEditingDrink(drink);
                        } else {
                          quickAddDrink(drink.name, drink.category);
                        }
                      }}
                      className={`w-full bg-white/10 backdrop-blur rounded-xl py-3 font-semibold transition-all ${
                        editMode ? 'hover:bg-white/20 ring-2 ring-purple-400/50' : 'hover:bg-purple-500 hover:scale-105 active:scale-95'
                      }`}
                    >
                      <div>{drink.name}</div>
                      <div className="text-xs text-slate-300 mt-1">{drink.category}</div>
                    </button>
                    {editMode && (
                      <button
                        onClick={() => removeFromQuickLog(drink.name)}
                        className="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 rounded-full p-1 shadow-lg"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    )}
                  </div>
                ))}
              </div>
              
              {!editMode && (
                !showOtherForm ? (
                  <button
                    onClick={() => setShowOtherForm(true)}
                    className="w-full bg-white/10 backdrop-blur hover:bg-white/20 rounded-xl py-3 font-semibold transition-colors flex items-center justify-center gap-2"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    Other
                  </button>
                ) : (
                  <div className="bg-white/10 backdrop-blur rounded-xl p-4">
                    <input
                      type="text"
                      placeholder="What did you drink?"
                      value={customDrink}
                      onChange={(e) => setCustomDrink(e.target.value)}
                      className="w-full bg-white/20 rounded-lg px-4 py-3 mb-3 text-white placeholder-slate-400 outline-none focus:ring-2 focus:ring-purple-400"
                      autoFocus
                    />
                    <div className="text-sm text-slate-300 mb-2">Select category:</div>
                    <div className="flex gap-2 mb-3">
                      <button
                        onClick={() => addCustomDrink('Beer')}
                        className="flex-1 bg-amber-500/20 hover:bg-amber-500 border border-amber-500/50 rounded-lg py-2 font-semibold transition-colors"
                      >
                        Beer
                      </button>
                      <button
                        onClick={() => addCustomDrink('Cocktail')}
                        className="flex-1 bg-pink-500/20 hover:bg-pink-500 border border-pink-500/50 rounded-lg py-2 font-semibold transition-colors"
                      >
                        Cocktail
                      </button>
                      <button
                        onClick={() => addCustomDrink('Wine')}
                        className="flex-1 bg-red-500/20 hover:bg-red-500 border border-red-500/50 rounded-lg py-2 font-semibold transition-colors"
                      >
                        Wine
                      </button>
                    </div>
                    <button
                      onClick={() => {
                        setShowOtherForm(false);
                        setCustomDrink('');
                      }}
                      className="w-full bg-white/20 hover:bg-white/30 rounded-lg py-2 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                )
              )}
            </div>

            <div className="space-y-3">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold text-slate-300">History</h2>
                {drinks.length > 0 && (
                  <button
                    onClick={exportToCSV}
                    className="text-sm text-purple-400 hover:text-purple-300 flex items-center gap-1 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors"
                  >
                    Export CSV
                  </button>
                )}
              </div>
              {drinks.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <p>No drinks logged yet</p>
                  <p className="text-sm mt-2">Tap a button above to start tracking</p>
                </div>
              ) : (
                drinks.map((drink) => (
                  <div
                    key={drink.id}
                    className="bg-white/10 backdrop-blur rounded-xl p-4 flex items-center justify-between hover:bg-white/15 transition-colors"
                  >
                    <div>
                      <div className="font-semibold text-lg">{drink.name}</div>
                      <div className="text-slate-300 text-sm">
                        {drink.category} â€¢ {formatDate(drink.timestamp)} at {formatTime(drink.timestamp)}
                      </div>
                    </div>
                    <button
                      onClick={() => deleteDrink(drink.id)}
                      className="text-red-400 hover:text-red-300 text-sm px-3 py-1 rounded-lg hover:bg-white/10 transition-colors"
                    >
                      Delete
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<DrinkTracker />, document.getElementById('root'));
  </script>
</body>
</html>
